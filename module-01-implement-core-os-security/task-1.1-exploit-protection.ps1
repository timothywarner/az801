<#
.SYNOPSIS
    Task 1.1 - Configure Windows Defender Exploit Protection

.DESCRIPTION
    Demo script for AZ-801 Module 1: Implement Core OS Security
    This script demonstrates how to configure and manage Windows Defender Exploit Protection
    settings to mitigate common exploitation techniques.

.NOTES
    Module: Module 1 - Implement Core OS Security
    Task: 1.1 - Configure Windows Defender Exploit Protection

    Prerequisites:
    - Windows Server 2019 or later
    - Administrative privileges
    - Windows Defender enabled

    Lab Environment:
    - Windows Server 2022 recommended
    - PowerShell 5.1 or later

    PowerShell Version: 5.1+
#>

#Requires -RunAsAdministrator

# Script configuration
$ErrorActionPreference = 'Stop'

Write-Host "=== AZ-801 Module 1: Task 1.1 - Windows Defender Exploit Protection ===" -ForegroundColor Cyan
Write-Host ""

try {
    # Section 1: Display current Exploit Protection settings
    Write-Host "[Step 1] Checking current Exploit Protection configuration" -ForegroundColor Yellow

    # Get current process mitigation settings
    $processSettings = Get-ProcessMitigation -System

    Write-Host "Current System-wide DEP (Data Execution Prevention): $($processSettings.DEP.Enable)" -ForegroundColor White
    Write-Host "Current System-wide ASLR (Address Space Layout Randomization): $($processSettings.ASLR.ForceRelocateImages)" -ForegroundColor White

    Write-Host "[SUCCESS] Current settings retrieved" -ForegroundColor Green
    Write-Host ""

    # Section 2: Configure system-wide exploit protection
    Write-Host "[Step 2] Configuring system-wide exploit protection settings" -ForegroundColor Yellow

    # Enable DEP (Data Execution Prevention) for all processes
    Set-ProcessMitigation -System -Enable DEP, EmulateAtlThunks

    # Enable ASLR (Address Space Layout Randomization)
    Set-ProcessMitigation -System -Enable ForceRelocateImages, BottomUp, HighEntropy

    # Enable additional mitigations
    Set-ProcessMitigation -System -Enable SEHOP

    Write-Host "[SUCCESS] System-wide exploit protection configured" -ForegroundColor Green
    Write-Host ""

    # Section 3: Configure application-specific settings
    Write-Host "[Step 3] Configuring application-specific exploit protection (Example: notepad.exe)" -ForegroundColor Yellow

    # Example: Configure exploit protection for a specific application
    $appName = "notepad.exe"

    Set-ProcessMitigation -Name $appName -Enable DEP, BottomUp, SEHOP -Verbose

    Write-Host "[SUCCESS] Application-specific settings configured for $appName" -ForegroundColor Green
    Write-Host ""

    # Section 4: Export current configuration
    Write-Host "[Step 4] Exporting Exploit Protection configuration" -ForegroundColor Yellow

    $exportPath = "$env:TEMP\ExploitProtectionConfig.xml"

    # Export system configuration
    Get-ProcessMitigation -RegistryConfigFilePath $exportPath

    if (Test-Path $exportPath) {
        Write-Host "Configuration exported to: $exportPath" -ForegroundColor White
        Write-Host "[SUCCESS] Configuration exported successfully" -ForegroundColor Green
    }
    Write-Host ""

    # Section 5: Display configured settings
    Write-Host "[Step 5] Verifying updated Exploit Protection settings" -ForegroundColor Yellow

    $updatedSettings = Get-ProcessMitigation -System

    Write-Host "`nSystem-wide Mitigations:" -ForegroundColor Cyan
    Write-Host "  DEP Enabled: $($updatedSettings.DEP.Enable)" -ForegroundColor White
    Write-Host "  ASLR Force Relocate Images: $($updatedSettings.ASLR.ForceRelocateImages)" -ForegroundColor White
    Write-Host "  ASLR Bottom Up: $($updatedSettings.ASLR.BottomUp)" -ForegroundColor White
    Write-Host "  ASLR High Entropy: $($updatedSettings.ASLR.HighEntropy)" -ForegroundColor White
    Write-Host "  SEHOP Enabled: $($updatedSettings.SEHOP.Enable)" -ForegroundColor White

    Write-Host "[SUCCESS] Settings verified" -ForegroundColor Green
    Write-Host ""

    # Section 6: Educational notes
    Write-Host "[INFO] Exploit Protection Best Practices:" -ForegroundColor Cyan
    Write-Host "  - DEP prevents code execution in memory marked as data" -ForegroundColor White
    Write-Host "  - ASLR randomizes memory addresses to prevent exploitation" -ForegroundColor White
    Write-Host "  - SEHOP validates exception handler chain integrity" -ForegroundColor White
    Write-Host "  - Configure system-wide for baseline, per-app for specific needs" -ForegroundColor White
    Write-Host "  - Export configurations for backup and deployment" -ForegroundColor White
    Write-Host ""

} catch {
    Write-Host "[ERROR] $_" -ForegroundColor Red
    Write-Host $_.ScriptStackTrace -ForegroundColor Red
    exit 1
}

Write-Host "Demo completed successfully!" -ForegroundColor Green
Write-Host "Next Steps: Test application compatibility and deploy to production servers" -ForegroundColor Yellow
